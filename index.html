<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Report Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="Drop your one-sheet Excel/CSV and get a clean, printable monthly report. All in the browser."/>

  <style>
    html, body { height:auto; overflow:auto; }
    @page { size: Letter; margin:16mm; }
    .print-only { display:none; }
    @media print {
      body { background:#fff !important; }
      #uploader, #error, #controls, .no-print { display:none !important; }
      #report { box-shadow:none !important; width:auto !important; }
      .page { page-break-after:always; }
      .page:last-child { page-break-after:auto; }
      .print-only { display:block; }
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-rose-50 via-indigo-50 to-emerald-50">
<main class="max-w-6xl mx-auto px-6 py-10">
  <header class="text-center no-print">
    <h1 class="text-4xl md:text-5xl font-extrabold text-slate-800">Monthly Report Generator</h1>
    <p class="mt-3 text-slate-700">Upload your <span class="font-medium">one-sheet</span> Excel/CSV and get a pretty, printable report with flexible grouping.</p>
  </header>

  <!-- Controls / Uploader -->
  <section id="uploader" class="mt-8">
    <div class="flex flex-wrap gap-3 items-center" id="controls">
      <label for="file-input" class="cursor-pointer rounded-lg bg-white border border-slate-200 px-4 py-2 shadow hover:shadow-md">Choose file</label>
      <input id="file-input" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
      <button id="generateBtn" disabled class="rounded-lg px-4 py-2 bg-slate-200 text-slate-500 cursor-not-allowed">Generate report</button>
      <button id="printBtn" disabled class="rounded-lg px-4 py-2 bg-emerald-600 text-white">Print / Save PDF</button>
      <button id="dlRowsBtn" disabled class="rounded-lg px-4 py-2 bg-indigo-600 text-white">Download CSV</button>
      <button id="dlGroupedBtn" disabled class="rounded-lg px-4 py-2 bg-slate-800 text-white">Download Grouped CSV</button>
      <span class="text-sm text-slate-600">Accepted: .xlsx, .xls, .csv</span>
    </div>

    <div id="status" class="mt-4 hidden">
      <div class="rounded-xl border border-slate-200 bg-white/80 p-4 shadow-sm flex items-center gap-3">
        <div class="w-10 h-10 flex items-center justify-center rounded-lg bg-emerald-100 text-emerald-700">FILE</div>
        <div class="min-w-0 flex-1">
          <div id="fileName" class="font-medium text-slate-800 truncate">—</div>
          <div id="fileMeta" class="text-sm text-slate-600">—</div>
        </div>
        <button id="resetBtn" class="text-slate-500 hover:text-slate-700 text-sm">Reset</button>
      </div>
    </div>

    <!-- Drag & drop -->
    <label id="dropzone" for="file-input" class="mt-6 block text-center rounded-2xl border-2 border-dashed border-slate-300 bg-white/70 backdrop-blur-sm p-10 shadow-sm hover:shadow transition cursor-pointer">
      <p class="text-lg font-semibold text-slate-800">Drag & drop your Excel/CSV here</p>
      <p class="text-slate-600 mt-1">or click to choose a file</p>
    </label>

    <p id="error" class="mt-3 hidden text-sm text-rose-600"></p>
  </section>

  <!-- Report -->
  <section id="report" class="mt-12 hidden"></section>
</main>

<!-- SheetJS + Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // --- Elements ---
  const fileInput   = document.getElementById('file-input');
  const statusBox   = document.getElementById('status');
  const fileNameEl  = document.getElementById('fileName');
  const fileMetaEl  = document.getElementById('fileMeta');
  const errorEl     = document.getElementById('error');
  const generateBtn = document.getElementById('generateBtn');
  const printBtn    = document.getElementById('printBtn');
  const dlRowsBtn   = document.getElementById('dlRowsBtn');
  const dlGroupedBtn= document.getElementById('dlGroupedBtn');
  const report      = document.getElementById('report');
  const dropzone    = document.getElementById('dropzone');
  const resetBtn    = document.getElementById('resetBtn');

  // --- Helpers ---
  const isExcel = f => /\.(xlsx|xls)$/i.test(f.name);
  const isCSV   = f => /\.(csv)$/i.test(f.name);
  const formatBytes = b => { if (b===0) return '0 B'; const k=1024,S=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return (b/Math.pow(k,i)).toFixed(2)+' '+S[i]; };
  const currency = n => (n==null || isNaN(n)) ? '—' : n.toLocaleString(undefined,{style:'currency',currency:'USD'});
  const esc = s => String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const normalizeKey = (str)=> String(str||'')
    .trim()
    .toLowerCase()
    .normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9]+/g,' ')
    .replace(/\s+/g,' ')
    .trim();

  // --- DATE: fix “day before” by forcing UTC everywhere ---
  function excelSerialToISO(n){
    const o = XLSX.SSF.parse_date_code(n);
    if(!o) return '';
    const d = new Date(Date.UTC(o.y, (o.m||1)-1, o.d||1, o.H||0, o.M||0, Math.floor(o.S||0)));
    return d.toISOString().slice(0,10);
  }
  function normalizeDateCell(val){
    if (val == null || val === '') return '';
    if (typeof val === 'number') return excelSerialToISO(val);
    if (val instanceof Date && !isNaN(val)) return new Date(Date.UTC(val.getUTCFullYear(), val.getUTCMonth(), val.getUTCDate())).toISOString().slice(0,10);
    const s = String(val).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const d = new Date(s);
    return isNaN(d) ? '' : new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).toISOString().slice(0,10);
  }
  function formatISOAsLabel(iso){ // show nice label, still pinned to UTC
    if(!iso) return 'No date';
    const [y,m,d] = iso.split('-').map(Number);
    return new Date(Date.UTC(y, m-1, d)).toLocaleDateString(undefined,{timeZone:'UTC', month:'short', day:'numeric', year:'numeric'});
  }

  // Drag UI
  ['dragenter','dragover'].forEach(eName => dropzone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('ring-2','ring-emerald-400','bg-white'); }));
  ['dragleave','drop'].forEach(eName => dropzone.addEventListener(eName, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('ring-2','ring-emerald-400','bg-white'); }));
  dropzone.addEventListener('drop', e => { const f = e.dataTransfer?.files?.[0]; if (f) handleFile(f); });
  fileInput.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) handleFile(f); });
  if (resetBtn) resetBtn.addEventListener('click', () => location.reload());
  printBtn.addEventListener('click', () => window.print());

  function handleFile(file){
    errorEl.classList.add('hidden'); errorEl.textContent='';
    if(!(isExcel(file)||isCSV(file))){ errorEl.textContent='Please select .xlsx, .xls, or .csv'; errorEl.classList.remove('hidden'); return; }
    fileNameEl.textContent = file.name;
    fileMetaEl.textContent = `${formatBytes(file.size)} • ${new Date(file.lastModified).toLocaleString()}`;
    statusBox.classList.remove('hidden');
    [generateBtn, dlRowsBtn, dlGroupedBtn].forEach(b => b.disabled=true);
    generateBtn.disabled=false;
    generateBtn.classList.remove('cursor-not-allowed','bg-slate-200','text-slate-500');
    generateBtn.classList.add('bg-emerald-600','text-white');
    generateBtn.onclick = async () => buildReport(file);
  }

  // File readers
  const readWorkbook = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>{ try{res(XLSX.read(new Uint8Array(e.target.result),{type:'array'}));}catch(err){rej(err);} }; r.onerror=rej; r.readAsArrayBuffer(file); });
  const readCSV      = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>{ try{res(XLSX.read(e.target.result,{type:'string'}));}catch(err){rej(err);} }; r.onerror=rej; r.readAsText(file); });
  const toAOA        = ws => XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});

  // Parse main table
  function parseRows(aoa){
    if(!aoa || !aoa.length) return [];
    const headers = (aoa[0]||[]).map(h=> String(h||'').trim());
    const idx = {
      date: headers.findIndex(h=>/^date/i.test(h)),
      event: headers.findIndex(h=>/^event name/i.test(h)),
      type: headers.findIndex(h=>/^entry type/i.test(h)),
      cat:  headers.findIndex(h=>/^category/i.test(h)),
      desc: headers.findIndex(h=>/^description/i.test(h)),
      amt:  headers.findIndex(h=>/^amount/i.test(h)),
      pay:  headers.findIndex(h=>/^payment method/i.test(h)),
      notes:headers.findIndex(h=>/^notes/i.test(h)),
    };
    const rows=[];
    for(let i=1;i<aoa.length;i++){
      const r = aoa[i]||[];
      // amount
      const rawAmt = r[idx.amt];
      let amt = null;
      if(typeof rawAmt==='number') amt = rawAmt;
      else if(typeof rawAmt==='string'){ const n=parseFloat(rawAmt.replace(/[^0-9\-\.]/g,'')); amt = isNaN(n)? null : n; }

      const typ = (r[idx.type]||'').toString().trim().toLowerCase();
      const signedAmt = (typ==='expense') ? (amt!=null ? -amt : null) : amt;

      rows.push({
        date: normalizeDateCell(idx.date>-1 ? r[idx.date] : ''),
        event: (r[idx.event]||'').toString().trim(),
        type:  typ, // income|expense
        category: (r[idx.cat]||'').toString().trim(),
        description: (r[idx.desc]||'').toString().trim(),
        amount: signedAmt,
        method: (r[idx.pay]||'').toString().trim(),
        notes: (r[idx.notes]||'').toString().trim()
      });
    }
    return rows.filter(x=> x.description || (typeof x.amount==='number'));
  }

  // Find optional "Amount at Month Start" anywhere on sheet (same col, next row)
  function findStartingBalance(aoa){
    for(let r=0;r<Math.min(aoa.length,50);r++){
      for(let c=0;c<(aoa[r]||[]).length;c++){
        const cell = (aoa[r][c]??'').toString().trim();
        if(/^amount at month start/i.test(cell)){
          const below = aoa[r+1]?.[c];
          const right = aoa[r]?.[c+1];
          const candidates = [below, right];
          for(const v of candidates){
            if(typeof v==='number') return v;
            if(typeof v==='string'){ const n=parseFloat(v.replace(/[^0-9\-\.]/g,'')); if(!isNaN(n)) return n; }
          }
        }
      }
    }
    return 0;
  }

  const sum = (arr, pred)=> arr.reduce((a,b)=> a + (pred(b)||0), 0);

  function groupRows(rows, mode){
    const map = new Map();
    const labelMap = new Map();
    const push = (label, amt)=>{
      if (!map.has(label)) map.set(label,{income:0, expense:0, net:0});
      const e = map.get(label);
      if (amt>=0) e.income += amt; else e.expense += Math.abs(amt);
      e.net += amt;
    };

    for (const r of rows){
      let key;
      if (mode==='event'){
        const raw = r.event||'Unlabeled', norm = normalizeKey(raw)||'unlabeled';
        if (!labelMap.has(norm)) labelMap.set(norm, raw);
        key = labelMap.get(norm);
      } else if (mode==='category'){
        const raw = r.category||'Uncategorized', norm = normalizeKey(raw)||'uncategorized';
        if (!labelMap.has(norm)) labelMap.set(norm, raw);
        key = labelMap.get(norm);
      } else if (mode==='day'){
        key = r.date || 'No date';
      } else if (mode==='year'){
        key = r.date ? r.date.slice(0,4) : 'No date';
      } else {
        key = 'All';
      }
      if (typeof r.amount==='number') push(key, r.amount);
    }

    let labels = Array.from(map.keys());
    if (mode==='day'){
      labels.sort((a,b)=> new Date(a) - new Date(b));
    } else if (mode==='year'){
      labels.sort((a,b)=> a.localeCompare(b));
    } else {
      labels.sort((a,b)=> a.localeCompare(b));
    }
    return { labels, stats: map };
  }

  // Running balance (overall)
  function computeBalanceSeries(rows, startTotal){
    const byDay = new Map(); // iso -> net that day
    for(const r of rows){
      const d = r.date || 'No date';
      if(!byDay.has(d)) byDay.set(d,0);
      byDay.set(d, byDay.get(d) + (r.amount||0));
    }
    const days = Array.from(byDay.keys()).filter(d=>d!=='No date').sort((a,b)=> new Date(a)-new Date(b));
    const labels = days.map(d=> formatISOAsLabel(d));
    const series = [];
    let bal = startTotal||0;
    for(const d of days){
      bal += byDay.get(d);
      series.push(bal);
    }
    return {labels, data: series};
  }

  // Cash vs Bank balances (Bank includes Zelle)
  function methodBalances(rows, startCash=0, startBank=0){
    const norm = s => String(s||'').toLowerCase();
    let cash = startCash||0, bank = startBank||0;
    for(const r of rows){
      const m = norm(r.method);
      const amt = r.amount||0;
      if (m.includes('cash')) cash += amt;
      else bank += amt; // treat Bank/Zelle/unknown as bank bucket
    }
    return { cash, bank };
  }

  // Cards
  function card(title, value, extra){
    return `<div class="rounded-xl border ${extra} p-4">
      <div class="text-sm opacity-80">${title}</div>
      <div class="text-2xl font-bold mt-1">${value}</div>
    </div>`;
  }
  function cards(t){
    return `
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
        ${card('Total Income', currency(t.incomeAll), 'bg-emerald-50 text-emerald-700 border-emerald-200')}
        ${card('Total Expenses', currency(t.expenseAll), 'bg-rose-50 text-rose-700 border-rose-200')}
        ${card('Net', currency(t.netAll), t.netAll>=0 ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200')}
      </div>`;
  }

  function eventsOverviewTable(grouped){
    if (!grouped.labels.length) return `<p class="text-slate-600 mt-2">No events.</p>`;
    const rows = grouped.labels.map(k=>{
      const s = grouped.stats.get(k);
      return `<tr>
        <td class="py-1.5 pr-3">${esc(k)}</td>
        <td class="py-1.5 pr-3 text-right text-emerald-700">${currency(s.income)}</td>
        <td class="py-1.5 pr-3 text-right text-rose-700">${currency(s.expense)}</td>
        <td class="py-1.5 pr-3 text-right ${s.net>=0?'text-indigo-700':'text-amber-700'}">${currency(s.net)}</td>
      </tr>`;
    }).join('');
    return `<table class="w-full mt-3 text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="font-medium pb-1">Event (grouped)</th>
          <th class="font-medium pb-1 text-right">Income</th>
          <th class="font-medium pb-1 text-right">Expenses</th>
          <th class="font-medium pb-1 text-right">Net</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
  }

  function transactionsTable(all){
    if(!all || !all.length) return `<p class="text-slate-600 mt-2">No transactions.</p>`;
    const body = all.map(r=> `<tr>
      <td class="py-1.5 pr-3 whitespace-nowrap">${esc(r.date)}</td>
      <td class="py-1.5 pr-3">${esc(r.event || 'Unlabeled')}</td>
      <td class="py-1.5 pr-3">${esc(r.category)}</td>
      <td class="py-1.5 pr-3">${esc(r.description)}</td>
      <td class="py-1.5 pr-3 text-right ${r.amount>=0?'text-emerald-700':'text-rose-700'}">${currency(Math.abs(r.amount))} ${r.amount>=0?'(Income)':'(Expense)'}</td>
      <td class="py-1.5 pr-3">${esc(r.method)}</td>
      <td class="py-1.5 pr-3 text-slate-500">${esc(r.notes)}</td>
    </tr>`).join('');
    return `<table class="w-full mt-3 text-sm">
      <thead>
        <tr class="text-left text-slate-500">
          <th class="font-medium pb-1">Date</th>
          <th class="font-medium pb-1">Event</th>
          <th class="font-medium pb-1">Category</th>
          <th class="font-medium pb-1">Description</th>
          <th class="font-medium pb-1 text-right">Amount</th>
          <th class="font-medium pb-1">Method</th>
          <th class="font-medium pb-1">Notes</th>
        </tr>
      </thead>
      <tbody>${body}</tbody>
    </table>`;
  }

  // Charts
  let groupChart, pieChart, balChart;
  function renderGroupChart(canvas, grouped, mode, metric){
    const labels = (mode==='day') ? grouped.labels.map(formatISOAsLabel) : grouped.labels;
    const incomes  = grouped.labels.map(l => grouped.stats.get(l).income);
    const expenses = grouped.labels.map(l => grouped.stats.get(l).expense);
    const nets     = grouped.labels.map(l => grouped.stats.get(l).net);

    const datasets = [];
    if (metric==='both' || metric==='income'){
      datasets.push({ type:'bar', label:'Income',  data: incomes,  stack:'stack1' });
    }
    if (metric==='both' || metric==='expense'){
      datasets.push({ type:'bar', label:'Expenses', data: expenses, stack:'stack1' });
    }
    if (metric==='net'){
      datasets.push({ type:'line', label:'Net', data: nets, yAxisID:'y1', tension:.25, pointRadius:2 });
    } else {
      datasets.push({ type:'line', label:'Net', data: nets, yAxisID:'y1', borderWidth:1, borderDash:[4,4], pointRadius:0 });
    }

    if (groupChart) groupChart.destroy();
    groupChart = new Chart(canvas, {
      data: { labels, datasets },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{ mode:'index', intersect:false },
        plugins:{ legend:{ position:'bottom' } },
        scales:{
          x:{ stacked: metric!=='net' },
          y:{ stacked: metric!=='net', beginAtZero:true, ticks:{ callback:v=>'$'+v } },
          y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>'$'+v } }
        }
      }
    });
  }
  function renderPie(canvas, cash, bank){
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(canvas, {
      type:'pie',
      data:{ labels:['Cash','Bank (incl. Zelle)'], datasets:[{ data:[cash, bank] }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
    });
  }
  function renderBalanceLine(canvas, series){
    if (balChart) balChart.destroy();
    balChart = new Chart(canvas, {
      type:'line',
      data:{ labels: series.labels, datasets:[{ label:'Running Balance', data: series.data, tension:.25, pointRadius:2 }] },
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:false, ticks:{ callback:v=>'$'+v } } } }
    });
  }

  // CSV downloads
  function toCSV(arr){
    return arr.map(row=> row.map(v=>{
      const s = (v==null)? '' : String(v);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');
  }
  function download(name, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function buildReport(file){
    try{
      const wb = isCSV(file) ? await readCSV(file) : await readWorkbook(file);
      const ws = wb.Sheets[wb.SheetNames[0]];
      const aoa = toAOA(ws);
      const rows = parseRows(aoa);

      // Totals
      const totals = {
        incomeAll: sum(rows, r=> r.amount>0 ? r.amount : 0),
        expenseAll: sum(rows, r=> r.amount<0 ? -r.amount : 0)
      };
      totals.netAll = totals.incomeAll - totals.expenseAll;

      // Start balance detection + editable inputs
      const detectedStart = findStartingBalance(aoa) || 0;

      // Date range
      const dates = rows.map(r=>r.date).filter(Boolean).sort((a,b)=> new Date(a)-new Date(b));
      const rangeLabel = dates.length ? `${formatISOAsLabel(dates[0])} – ${formatISOAsLabel(dates[dates.length-1])}` : '—';

      report.innerHTML = `
        <!-- Print header -->
        <div class="print-only mb-4">
          <h1 class="text-3xl font-extrabold text-center">Matachinas Financial Report</h1>
          <p class="text-center text-slate-600">${esc(file.name)} • ${esc(rangeLabel)}</p>
        </div>

        <div class="page bg-white rounded-2xl shadow-sm p-6">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
              <h2 class="text-2xl font-extrabold text-slate-800">Monthly Financial Summary</h2>
              <p class="text-slate-600">File: ${esc(file.name)}</p>
              <p class="text-slate-500 text-sm">Period: ${esc(rangeLabel)}</p>
            </div>
            <div class="text-right text-sm text-slate-500">All amounts in USD</div>
          </div>

          ${cards(totals)}

          <!-- Grouping & metric -->
          <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
            <div>
              <label class="text-sm text-slate-600">Group by</label>
              <select id="groupSelect" class="block mt-1 border border-slate-300 rounded-lg px-3 py-2 bg-white">
                <option value="day">Date (day)</option>
                <option value="event">Event name</option>
                <option value="category">Category</option>
                <option value="year">Year</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-slate-600">Metric</label>
              <select id="metricSelect" class="block mt-1 border border-slate-300 rounded-lg px-3 py-2 bg-white">
                <option value="both">Income & Expenses</option>
                <option value="income">Income only</option>
                <option value="expense">Expenses only</option>
                <option value="net">Net (line)</option>
              </select>
            </div>
            <div class="border rounded-lg p-3 bg-slate-50">
              <div class="text-sm text-slate-600 mb-1">Starting balances</div>
              <div class="flex gap-2">
                <label class="text-sm flex-1">Cash
                  <input id="startCash" type="number" step="0.01" class="mt-1 w-full border rounded-lg px-2 py-1" value="0">
                </label>
                <label class="text-sm flex-1">Bank (incl. Zelle)
                  <input id="startBank" type="number" step="0.01" class="mt-1 w-full border rounded-lg px-2 py-1" value="${detectedStart.toFixed(2)}">
                </label>
              </div>
              <p class="text-xs text-slate-500 mt-1">Detected total start: ${currency(detectedStart)} (editable)</p>
            </div>
          </div>

          <!-- Charts -->
          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="h-80"><canvas id="groupChart"></canvas></div>
            <div class="h-80"><canvas id="methodPie"></canvas></div>
          </div>
          <div class="mt-6 h-72">
            <canvas id="balanceLine"></canvas>
          </div>
        </div>

        <div class="page bg-white rounded-2xl shadow-sm p-6 mt-8">
          <h3 class="text-xl font-bold text-slate-800">Events Overview (Grouped)</h3>
          <div id="eventsTable" class="mt-2"></div>
        </div>

        <div class="page bg-white rounded-2xl shadow-sm p-6 mt-8">
          <h3 class="text-xl font-bold text-slate-800">All Transactions</h3>
          ${transactionsTable(rows)}
        </div>
      `;

      // Enable actions
      printBtn.disabled = false;
      dlRowsBtn.disabled = false;
      dlGroupedBtn.disabled = false;

      // Wire up dynamic bits
      const groupSelect  = document.getElementById('groupSelect');
      const metricSelect = document.getElementById('metricSelect');
      const startCashInp = document.getElementById('startCash');
      const startBankInp = document.getElementById('startBank');
      const groupCanvas  = document.getElementById('groupChart');
      const pieCanvas    = document.getElementById('methodPie');
      const balCanvas    = document.getElementById('balanceLine');
      const evTableDiv   = document.getElementById('eventsTable');

      function recompute(){
        const mode   = groupSelect.value;
        const metric = metricSelect.value;
        const startCash = parseFloat(startCashInp.value||'0')||0;
        const startBank = parseFloat(startBankInp.value||'0')||0;

        const grouped = groupRows(rows, mode);
        renderGroupChart(groupCanvas, grouped, mode, metric);

        const mb = methodBalances(rows, startCash, startBank);
        renderPie(pieCanvas, mb.cash, mb.bank);

        const series = computeBalanceSeries(rows, startCash + startBank);
        renderBalanceLine(balCanvas, series);

        const evGrouped = groupRows(rows, 'event');
        evTableDiv.innerHTML = eventsOverviewTable(evGrouped);

        // update grouped CSV button behavior
        dlGroupedBtn.onclick = ()=>{
          const csvArr = [['Label','Income','Expenses','Net']];
          for(const l of grouped.labels){
            const s = grouped.stats.get(l);
            csvArr.push([l, s.income.toFixed(2), s.expense.toFixed(2), s.net.toFixed(2)]);
          }
          download('grouped.csv', toCSV(csvArr));
        };
      }

      groupSelect.value = 'day'; // default as requested
      metricSelect.value = 'both';
      ['change','input'].forEach(ev=>{
        groupSelect.addEventListener(ev, recompute);
        metricSelect.addEventListener(ev, recompute);
        startCashInp.addEventListener(ev, recompute);
        startBankInp.addEventListener(ev, recompute);
      });
      recompute();

      // CSV of normalized rows
      dlRowsBtn.onclick = ()=>{
        const header = ['Date','Event Name','Entry Type','Category','Description','AmountSigned','Method','Notes'];
        const data = rows.map(r=> [r.date, r.event, r.type, r.category, r.description, r.amount, r.method, r.notes]);
        download('transactions_normalized.csv', toCSV([header, ...data]));
      };

      report.classList.remove('hidden');
    } catch(err){
      errorEl.textContent = 'Could not read file. Make sure it uses the one-sheet headers.';
      errorEl.classList.remove('hidden');
      console.error(err);
    }
  }

  // Initial disabled state
  (function init(){ generateBtn.disabled = true; printBtn.disabled = true; dlRowsBtn.disabled = true; dlGroupedBtn.disabled = true; })();
</script>
</body>
</html>
