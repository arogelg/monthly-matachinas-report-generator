<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Elements
  const fileInput = document.getElementById('file-input');
  const statusBox = document.getElementById('status');
  const fileNameEl = document.getElementById('fileName');
  const fileMetaEl = document.getElementById('fileMeta');
  const errorEl = document.getElementById('error');
  const generateBtn = document.getElementById('generateBtn');
  const printBtn = document.getElementById('printBtn');
  const report = document.getElementById('report');
  const dropzone = document.getElementById('dropzone');
  const resetBtn = document.getElementById('resetBtn');
  const progressEl = document.getElementById('progress');

  // Helpers
  const isExcel = (f) => /\.(xlsx|xls)$/i.test(f.name);
  const isCSV   = (f) => /\.(csv)$/i.test(f.name);
  const formatBytes = (bytes) => { if(bytes===0) return '0 B'; const k=1024, sizes=['B','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i]; };
  const currency = (n) => n==null||isNaN(n) ? '—' : n.toLocaleString(undefined,{style:'currency',currency:'USD'});
  const normalize = (s) => (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase();

  // Drag UI
  ['dragenter','dragover'].forEach(eName => dropzone.addEventListener(eName, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('ring-2','ring-emerald-400','bg-white'); }));
  ['dragleave','drop'].forEach(eName => dropzone.addEventListener(eName, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('ring-2','ring-emerald-400','bg-white'); }));
  dropzone.addEventListener('drop', (e)=>{ const f=e.dataTransfer?.files?.[0]; if(f) handleFile(f); });
  fileInput.addEventListener('change', (e)=>{ const f=e.target.files?.[0]; if(f) handleFile(f); });

  function handleFile(file){
    errorEl.classList.add('hidden'); errorEl.textContent='';
    if(!(isExcel(file)||isCSV(file))){ errorEl.textContent='Please select .xlsx, .xls, or .csv'; errorEl.classList.remove('hidden'); return; }
    fileNameEl.textContent = file.name;
    fileMetaEl.textContent = `${formatBytes(file.size)} • ${new Date(file.lastModified).toLocaleString()}`;
    statusBox.classList.remove('hidden');
    generateBtn.disabled=false; generateBtn.classList.remove('cursor-not-allowed','bg-slate-200','text-slate-500'); generateBtn.classList.add('bg-emerald-600','text-white');
    generateBtn.onclick = async ()=> buildReport(file);
  }
  if (resetBtn) resetBtn.addEventListener('click', ()=>{ location.reload(); });
  printBtn.addEventListener('click', ()=> window.print());

  // File readers
  const readWorkbook = (file)=> new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=(e)=>{ try{ const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'}); resolve(wb);}catch(err){reject(err);} }; r.onerror=reject; r.readAsArrayBuffer(file); });
  const readCSV = (file)=> new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=(e)=>{ try{ const wb=XLSX.read(e.target.result,{type:'string'}); resolve(wb);}catch(err){reject(err);} }; r.onerror=reject; r.readAsText(file); });
  const toAOA = (ws)=> XLSX.utils.sheet_to_json(ws,{header:1,raw:true,defval:null});

  // Parse expected one-sheet template
  function parseRows(aoa){
    if(!aoa || !aoa.length) return [];
    const headers = (aoa[0]||[]).map(h=> String(h||'').trim());
    const idx = {
      date: headers.findIndex(h=>/^date/i.test(h)),
      event: headers.findIndex(h=>/^event name/i.test(h)),
      type:  headers.findIndex(h=>/^entry type/i.test(h)),
      cat:   headers.findIndex(h=>/^category/i.test(h)),
      desc:  headers.findIndex(h=>/^description/i.test(h)),
      amt:   headers.findIndex(h=>/^amount/i.test(h)),
      pay:   headers.findIndex(h=>/^payment method/i.test(h)),
      notes: headers.findIndex(h=>/^notes/i.test(h)),
    };
    const out=[];
    for(let i=1;i<aoa.length;i++){
      const r = aoa[i]||[];
      const rawAmt = r[idx.amt];
      let amt = null;
      if(typeof rawAmt==='number') amt = rawAmt;
      else if(typeof rawAmt==='string'){ const n=parseFloat(rawAmt.replace(/[^0-9\-.]/g,'')); amt = isNaN(n)? null : n; }
      const typ = (r[idx.type]||'').toString().trim().toLowerCase();
      const signedAmt = (typ==='expense') ? (amt!=null ? -amt : null) : amt;
      const eventName = (r[idx.event]||'').toString().trim();
      out.push({
        date: r[idx.date] ? String(r[idx.date]).slice(0,10) : '',
        event: eventName,
        eventKey: normalize(eventName),
        type: typ,
        category: (r[idx.cat]||'').toString().trim(),
        description: (r[idx.desc]||'').toString().trim(),
        amount: signedAmt,
        method: (r[idx.pay]||'').toString().trim(),
        notes: (r[idx.notes]||'').toString().trim()
      });
    }
    return out.filter(x=> x.event || x.description || (typeof x.amount==='number'));
  }

  // Groupers
  function groupByEvent(rows){
    const map = {}, display = {};
    for(const r of rows){
      const key = r.eventKey || '(sin nombre)';
      if(!map[key]){ map[key] = {income:0, expense:0, net:0, rows:[]}; display[key] = r.event || '(Sin nombre)'; }
      if(typeof r.amount==='number'){ if(r.amount>=0) map[key].income += r.amount; else map[key].expense += Math.abs(r.amount); map[key].net += r.amount; }
      map[key].rows.push(r);
    }
    return {map, display};
  }
  function groupByTypePerEvent(rows, want){
    const filtered = rows.filter(r => (want==='income') ? r.amount>=0 : r.amount<0);
    const map = {}, display = {};
    for(const r of filtered){
      const key = r.eventKey || '(sin nombre)';
      if(!map[key]){ map[key]=0; display[key] = r.event || '(Sin nombre)'; }
      map[key] += Math.abs(r.amount||0);
    }
    return {map, display};
  }
  function groupByDate(rows){
    const months = new Set(rows.filter(r=>r.date).map(r=> r.date.slice(0,7)));
    const useMonthly = months.size > 1;
    const keyOf = (d)=> d ? (useMonthly ? d.slice(0,7) : d.slice(0,10)) : '(sin fecha)';
    const map = {};
    for(const r of rows){
      const k = keyOf(r.date);
      if(!map[k]) map[k] = {income:0, expense:0, net:0};
      if(typeof r.amount==='number'){ if(r.amount>=0) map[k].income += r.amount; else map[k].expense += Math.abs(r.amount); map[k].net += r.amount; }
    }
    return {map, label: useMonthly ? 'Month' : 'Date'};
  }

  // Render helpers
  function card(title, value, extra){
    return `<div class="rounded-xl border ${extra} p-4">
      <div class="text-sm opacity-80">${title}</div>
      <div class="text-2xl font-bold mt-1">${value}</div>
    </div>`;
  }
  function sectionWithChartAndTable(title, labels, datasets, tableHTML){
    return `<div>
      <h3 class="text-xl font-bold text-slate-800 mb-2">${escapeHTML(title)}</h3>
      <div class="bg-white rounded-xl shadow-sm p-4"><canvas id="sectionChart" height="130"></canvas></div>
      <div class="bg-white rounded-xl shadow-sm p-4 mt-4">${tableHTML}</div>
    </div>`;
  }
  function sectionWithChartOnly(title, labels, values){
    return `<div>
      <h3 class="text-xl font-bold text-slate-800 mb-2">${escapeHTML(title)}</h3>
      <div class="bg-white rounded-xl shadow-sm p-4"><canvas id="sectionChart" height="130"></canvas></div>
    </div>`;
  }
  function tableFromMap(display, map){
    const keys = Object.keys(map);
    const rows = keys.map(k=>{ const s=map[k]; return `<tr>
      <td class="py-1.5 pr-3">${escapeHTML(display[k])}</td>
      <td class="py-1.5 pr-3 text-right text-emerald-700">${currency(s.income)}</td>
      <td class="py-1.5 pr-3 text-right text-rose-700">${currency(s.expense)}</td>
      <td class="py-1.5 pr-3 text-right ${s.net>=0?'text-indigo-700':'text-amber-700'}">${currency(s.net)}</td>
    </tr>`; }).join('');
    return `<table class="w-full text-sm"><thead><tr class="text-left text-slate-500">
      <th class="font-medium pb-1">Event</th><th class="font-medium pb-1 text-right">Income</th>
      <th class="font-medium pb-1 text-right">Expenses</th><th class="font-medium pb-1 text-right">Net</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
  }
  function tableFromSimpleMap(keys, map){
    const rows = keys.map(k=>{ const s=map[k]; return `<tr>
      <td class="py-1.5 pr-3">${escapeHTML(k)}</td>
      <td class="py-1.5 pr-3 text-right text-emerald-700">${currency(s.income)}</td>
      <td class="py-1.5 pr-3 text-right text-rose-700">${currency(s.expense)}</td>
      <td class="py-1.5 pr-3 text-right ${s.net>=0?'text-indigo-700':'text-amber-700'}">${currency(s.net)}</td>
    </tr>`; }).join('');
    return `<table class="w-full text-sm"><thead><tr class="text-left text-slate-500">
      <th class="font-medium pb-1">Group</th><th class="font-medium pb-1 text-right">Income</th>
      <th class="font-medium pb-1 text-right">Expenses</th><th class="font-medium pb-1 text-right">Net</th>
    </tr></thead><tbody>${rows}</tbody></table>`;
  }
  function drawChart(canvasId, labels, datasets){
    const ctx = document.getElementById(canvasId);
    if(!ctx || typeof Chart==='undefined') return;
    new Chart(ctx, { type:'bar', data:{ labels, datasets }, options:{ responsive:true, plugins:{ legend:{ position:'bottom' } }, scales:{ y:{ beginAtZero:true } } } });
  }
  function escapeHTML(str){ return String(str??'').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

  // Build report with view switcher (no non-event split)
  async function buildReport(file){
    try{
      if (typeof XLSX === 'undefined') { throw new Error('Excel library failed to load.'); }
      progressEl.classList.remove('hidden'); errorEl.classList.add('hidden'); errorEl.textContent='';

      const wb = isCSV(file) ? await readCSV(file) : await readWorkbook(file);
      if(!wb.SheetNames?.length) throw new Error('No sheets found.');
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = parseRows(toAOA(ws)).map(r=> ({...r, eventKey: normalize(r.event)}));
      if(!rows.length) throw new Error('No transactions found.');

      const totals = {
        incomeAll: rows.reduce((a,r)=> a + (r.amount>0? r.amount:0), 0),
        expenseAll: rows.reduce((a,r)=> a + (r.amount<0? -r.amount:0), 0),
      };
      totals.netAll = totals.incomeAll - totals.expenseAll;

      report.innerHTML = `
        <div class="page bg-white rounded-2xl shadow-sm p-6">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
              <h2 class="text-2xl font-extrabold text-slate-800">Financial Summary</h2>
              <p class="text-slate-600">File: ${escapeHTML(file.name)}</p>
            </div>
            <div class="flex items-center gap-2">
              <label for="viewMode" class="text-sm text-slate-600">View:</label>
              <select id="viewMode" class="rounded-md border border-slate-300 px-2 py-1 text-sm">
                <option value="date">By Date (default)</option>
                <option value="event">By Event</option>
                <option value="income">By Type: Income</option>
                <option value="expense">By Type: Expense</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
            ${card('Total Income', currency(totals.incomeAll), 'bg-emerald-50 text-emerald-700 border-emerald-200')}
            ${card('Total Expenses', currency(totals.expenseAll), 'bg-rose-50 text-rose-700 border-rose-200')}
            ${card('Net', currency(totals.netAll), totals.netAll>=0 ? 'bg-indigo-50 text-indigo-700 border-indigo-200' : 'bg-amber-50 text-amber-700 border-amber-200')}
          </div>

          <div id="viewContainer" class="mt-8"></div>
        </div>

        <div class="page bg-white rounded-2xl shadow-sm p-6 mt-8">
          <h3 class="text-xl font-bold text-slate-800">Events Overview</h3>
          <div id="eventsOverview"></div>
        </div>
      `;
      printBtn.disabled = false;

      const viewModeEl = document.getElementById('viewMode');
      const viewContainer = document.getElementById('viewContainer');
      const eventsOverview = document.getElementById('eventsOverview');

      const renderByEvent = ()=>{
        const {map, display} = groupByEvent(rows);
        const labels = Object.keys(map).map(k=> display[k]);
        const incomes = Object.keys(map).map(k=> map[k].income);
        const expenses = Object.keys(map).map(k=> map[k].expense);
        viewContainer.innerHTML = sectionWithChartAndTable('By Event — Income vs Expenses', labels, [
          {label:'Income', data: incomes}, {label:'Expenses', data: expenses}
        ], tableFromMap(display, map));
        drawChart('sectionChart', labels, [
          {label:'Income', data: incomes}, {label:'Expenses', data: expenses}
        ]);
      };

      const renderByType = (type)=>{
        const {map, display} = groupByTypePerEvent(rows, type);
        const labels = Object.keys(map).map(k=> display[k]);
        const values = Object.keys(map).map(k=> map[k]);
        const title = type==='income' ? 'Income by Event' : 'Expenses by Event';
        viewContainer.innerHTML = sectionWithChartOnly(title, labels, values);
        drawChart('sectionChart', labels, [ {label:title, data: values} ]);
      };

      const renderByDate = ()=>{
        const {map, label} = groupByDate(rows);
        const keys = Object.keys(map).sort();
        const incomes = keys.map(k=> map[k].income);
        const expenses = keys.map(k=> map[k].expense);
        viewContainer.innerHTML = sectionWithChartAndTable(`By ${label} — Income vs Expenses`, keys, [
          {label:'Income', data: incomes}, {label:'Expenses', data: expenses}
        ], tableFromSimpleMap(keys, map));
        drawChart('sectionChart', keys, [
          {label:'Income', data: incomes}, {label:'Expenses', data: expenses}
        ]);
      };

      const renderEventsOverview = ()=>{
        const {map, display} = groupByEvent(rows);
        const keys = Object.keys(map);
        if(keys.length===0){ eventsOverview.innerHTML = `<p class="text-slate-600 mt-2">No events in this period.</p>`; return; }
        const body = keys.map(k=>{
          const s = map[k];
          return `<tr>
            <td class="py-1.5 pr-3">${escapeHTML(display[k])}</td>
            <td class="py-1.5 pr-3 text-right text-emerald-700">${currency(s.income)}</td>
            <td class="py-1.5 pr-3 text-right text-rose-700">${currency(s.expense)}</td>
            <td class="py-1.5 pr-3 text-right ${s.net>=0?'text-indigo-700':'text-amber-700'}">${currency(s.net)}</td>
          </tr>`;
        }).join('');
        eventsOverview.innerHTML = `<table class="w-full mt-3 text-sm">
          <thead><tr class="text-left text-slate-500">
            <th class="font-medium pb-1">Event</th>
            <th class="font-medium pb-1 text-right">Income</th>
            <th class="font-medium pb-1 text-right">Expenses</th>
            <th class="font-medium pb-1 text-right">Net</th>
          </tr></thead><tbody>${body}</tbody></table>`;
      };

      function rerender(){
        const mode = viewModeEl.value;
        if(mode==='event') renderByEvent();
        else if(mode==='income') renderByType('income');
        else if(mode==='expense') renderByType('expense');
        else renderByDate();   // default
        renderEventsOverview();
      }
      viewModeEl.addEventListener('change', rerender);
      rerender(); // default By Date
      report.classList.remove('hidden');
      progressEl.classList.add('hidden');

    } catch(err){
      errorEl.textContent = 'Could not read file: ' + ((err&&err.message)||String(err));
      errorEl.classList.remove('hidden');
      if(progressEl) progressEl.classList.add('hidden');
      console.error(err);
    }
  }

  // Init disabled state
  (function init(){ generateBtn.disabled = true; printBtn.disabled = true; })();
</script>
